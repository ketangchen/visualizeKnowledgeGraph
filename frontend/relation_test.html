<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>关系显示测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            color: #007bff;
            margin-top: 0;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            margin: 10px 0; 
            font-family: monospace; 
            max-height: 300px;
            overflow-y: auto;
        }
        .relation-info {
            background: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .relation-info h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .relation-list {
            list-style: none;
            padding: 0;
        }
        .relation-list li {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .relation-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>知识图谱关系显示测试</h1>
        
        <div class="test-section">
            <h3>数据加载测试</h3>
            <button id="load-data-btn">加载图谱数据</button>
            <button id="analyze-relations-btn" disabled>分析关系类型</button>
            <div class="log" id="log"></div>
        </div>

        <div class="test-section">
            <h3>关系类型分析</h3>
            <div id="relation-analysis"></div>
        </div>

        <div class="test-section">
            <h3>边类型映射测试</h3>
            <div id="edge-type-mapping"></div>
        </div>
    </div>

    <script>
        let graphData = null;

        function log(msg) {
            const logElement = document.getElementById('log');
            logElement.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 根据关系类型自动设置边类型
        function getEdgeTypeForRelation(relationType) {
            const mapping = {
                '继承': 'solid-triangle',        // 空心三角箭头
                '泛化': 'solid-triangle',        // 空心三角箭头
                '实现': 'dashed-triangle',       // 虚线空心三角箭头
                '关联': 'solid-arrow',           // 实线箭头
                '聚合': 'hollow-diamond',        // 空心菱形
                '组合': 'solid-diamond',        // 实心菱形
                '依赖': 'dashed-arrow',          // 虚线箭头
                '多态': 'solid-arrow',           // 实线箭头
                '嵌套类': 'solid-arrow',         // 实线箭头
                '友元': 'solid-arrow',           // 实线箭头
                '泛型': 'solid-arrow',           // 实线箭头
                '关联类': 'solid-arrow',         // 实线箭头
                '角色限定关联': 'solid-arrow'    // 实线箭头
            };
            return mapping[relationType] || 'solid-arrow';
        }

        // 检测和处理重复关系
        function processDuplicateRelations(links) {
            const processedLinks = [];
            const relationMap = new Map();
            
            links.forEach(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                const relationKey = `${sourceId}-${targetId}`;
                const reverseKey = `${targetId}-${sourceId}`;
                
                // 检查是否已存在相同方向的关系
                if (relationMap.has(relationKey)) {
                    log(`发现重复关系: ${relationKey} (${link.type})`);
                    return;
                }
                
                // 检查是否存在反向关系
                if (relationMap.has(reverseKey)) {
                    log(`发现反向关系: ${relationKey} 与 ${reverseKey}`);
                    if (link.type === '多态' || link.type === '关联') {
                        link.isBidirectional = true;
                    }
                }
                
                relationMap.set(relationKey, link);
                processedLinks.push(link);
            });
            
            return processedLinks;
        }

        async function loadGraphData() {
            log('开始加载图谱数据...');
            
            try {
                const response = await fetch('/api/kg/data');
                log('API调用成功，状态码: ' + response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    log('响应解析成功，ret: ' + result.ret);
                    
                    if (result.ret === 0) {
                        graphData = result.data;
                        log('数据获取成功');
                        log('实体数量: ' + (graphData.nodes ? graphData.nodes.length : 0));
                        log('关系数量: ' + (graphData.links ? graphData.links.length : 0));
                        
                        // 处理重复关系
                        if (graphData.links) {
                            graphData.links = processDuplicateRelations(graphData.links);
                        }
                        
                        document.getElementById('analyze-relations-btn').disabled = false;
                        alert('数据加载成功！可以开始分析关系类型。');
                    } else {
                        log('API返回错误: ' + result.msg);
                    }
                } else {
                    log('HTTP错误: ' + response.status);
                }
            } catch (error) {
                log('错误: ' + error.message);
            }
        }

        function analyzeRelations() {
            if (!graphData || !graphData.links) {
                log('请先加载数据');
                return;
            }

            log('开始分析关系类型...');
            
            // 统计关系类型
            const relationTypes = {};
            const edgeTypeMapping = {};
            
            graphData.links.forEach(link => {
                const type = link.type || '未知';
                if (!relationTypes[type]) {
                    relationTypes[type] = 0;
                }
                relationTypes[type]++;
                
                // 获取对应的边类型
                const edgeType = getEdgeTypeForRelation(type);
                edgeTypeMapping[type] = edgeType;
                
                // 特别检查组合关系
                if (type === '组合') {
                    log(`组合关系详情: ID=${link.id}, 边类型=${link.edgeType || edgeType}, 源=${link.source}, 目标=${link.target}`);
                }
            });

            // 显示关系分析结果
            const analysisDiv = document.getElementById('relation-analysis');
            let html = '<h4>关系类型统计:</h4><ul class="relation-list">';
            
            Object.keys(relationTypes).forEach(type => {
                const count = relationTypes[type];
                const edgeType = edgeTypeMapping[type];
                html += `<li><strong>${type}</strong>: ${count}个 (边类型: ${edgeType})</li>`;
            });
            
            html += '</ul>';
            analysisDiv.innerHTML = html;

            // 显示边类型映射
            const mappingDiv = document.getElementById('edge-type-mapping');
            let mappingHtml = '<h4>边类型映射:</h4><ul class="relation-list">';
            
            Object.keys(edgeTypeMapping).forEach(type => {
                const edgeType = edgeTypeMapping[type];
                mappingHtml += `<li><strong>${type}</strong> → ${edgeType}</li>`;
            });
            
            mappingHtml += '</ul>';
            mappingDiv.innerHTML = mappingHtml;

            log('关系分析完成');
        }

        // 事件监听器
        document.getElementById('load-data-btn').addEventListener('click', loadGraphData);
        document.getElementById('analyze-relations-btn').addEventListener('click', analyzeRelations);
        
        log('页面加载完成，点击"加载图谱数据"开始测试');
    </script>
</body>
</html>
